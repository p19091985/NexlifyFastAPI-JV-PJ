{% set theme_mode = 'dark' if settings.theme in ['darkly', 'slate', 'solar', 'superhero', 'vapor', 'cyborg'] else 'light' %}
{% macro px_to_rem(px_value, default_rem='0.375rem', base_font=16) %}
    {% if px_value is defined and px_value is number %}
        {{ (px_value | float / base_font) | round(3) }}rem
    {% else %}
        {{ default_rem }}
    {% endif %}
{% endmacro %}
{% macro hex_to_rgb_str(hex_color, default_rgb='0,0,0') %}
    {% set h = hex_color | replace('#', '') %}
    {% if h and h | length == 6 %}
        {{ h[0:2] | int(base=16) }},{{ h[2:4] | int(base=16) }},{{ h[4:6] | int(base=16) }}
    {% elif h and h | length == 3 %}
        {{ (h[0]*2) | int(base=16) }},{{ (h[1]*2) | int(base=16) }},{{ (h[2]*2) | int(base=16) }}
    {% else %}
        {{ default_rgb }}
    {% endif %}
{% endmacro %}
{% set border_radius_rem = px_to_rem(settings.border_radius, default_rem='0.375rem') %}
{% set border_width_px = (settings.border_width | string) + 'px' if settings.border_width is defined and settings.border_width is number else '1px' %}
{% set font_size_rem = px_to_rem(settings.font_size, default_rem='1rem') %}
{% set primary_rgb_val = hex_to_rgb_str(settings.custom_colors.primary, default_rgb='13,110,253') %}
<!doctype html>
<html lang="pt-br" data-bs-theme="{{ theme_mode }}">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{% block title %}Nexlify FastAPI{% endblock %}</title>
    <link href="/static/css/bootstrap.min.css" rel="stylesheet">
    <link href="/static/css/custom.css" rel="stylesheet">
    {% include "_theme_style.html" %}
    <style>
        /* Estilos inline mínimos remanescentes (opcional) */
        .htmx-indicator { opacity: 0; transition: opacity 200ms ease-in; }
        .htmx-request .htmx-indicator { opacity: 1; }
        .htmx-request.htmx-indicator { opacity: 1; }
        .lib-status { font-size: 0.875rem; }
    </style>
</head>
<body>
    <button class="btn btn-light d-lg-none" type="button" data-bs-toggle="offcanvas" data-bs-target="#sidebarOffcanvas" aria-controls="sidebarOffcanvas" id="sidebar-toggler">
        ☰
    </button>
    <div class="offcanvas-lg offcanvas-start bg-body-tertiary" tabindex="-1" id="sidebarOffcanvas" aria-labelledby="sidebarOffcanvasLabel">
      <div class="offcanvas-header d-lg-none">
            <h5 class="offcanvas-title" id="sidebarOffcanvasLabel">Menu</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" data-bs-target="#sidebarOffcanvas" aria-label="Close"></button>
       </div>
       <div class="offcanvas-body p-0">
           <div id="sidebar">
               {% include "_sidebar.html" %}
           </div>
       </div>
    </div>
    <main>
         {% block content %}{% endblock %}
    </main>
    <script src="/static/js/apexcharts.min.js"></script>
    <script src="/static/js/bootstrap.bundle.min.js"></script>
    <script src="/static/js/htmx.min.js"></script>
    <script src="/static/js/charts_initializer.js" defer></script>
    <script nonce="{{ request.scope.get('csp_nonce', '') }}">
        // Promise global para ApexCharts - Assume carregamento local
        window.apexChartsLoaded = new Promise((resolve, reject) => {
            // Verifica se ApexCharts foi carregado pelo script local síncrono
            if (typeof ApexCharts !== 'undefined') {
                console.log('✓ ApexCharts carregado localmente.');
                resolve();
            } else {
                // Se não foi carregado localmente, rejeita a promise.
                // O script charts_initializer.js tratará o erro.
                console.error('✗ ApexCharts não encontrado localmente. Verifique se o arquivo /static/js/apexcharts.min.js existe e está correto.');
                reject(new Error('ApexCharts falhou ao carregar localmente'));
            }
        });
        // Script da Sidebar (mantido)
        const sidebar = document.getElementById('sidebar');
        const sidebarOffcanvas = document.getElementById('sidebarOffcanvas');
        if (sidebarOffcanvas && sidebar) {
             sidebarOffcanvas.addEventListener('show.bs.offcanvas', () => { if (window.innerWidth < 992) { sidebar.classList.add('show'); } });
             sidebarOffcanvas.addEventListener('hide.bs.offcanvas', () => { if (window.innerWidth < 992) { sidebar.classList.remove('show'); } });
             function adjustSidebarVisibility() { if (window.innerWidth >= 992) { sidebar.classList.add('show'); sidebarOffcanvas.classList.remove('show'); } else { if (!sidebarOffcanvas.classList.contains('show')) { sidebar.classList.remove('show'); } } }
             adjustSidebarVisibility();
             window.addEventListener('resize', adjustSidebarVisibility);
        }
        // Script DOMContentLoaded (mantido)
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Página carregada - verificando ApexCharts...');
            window.apexChartsLoaded
                .then(() => { console.log('✓ Assets locais prontos.'); })
                .catch(err => { console.error('✗ Erro crítico nos assets:', err); });
        });
    </script>
</body>
</html>