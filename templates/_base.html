{% set theme_mode = 'dark' if settings.theme in ['darkly', 'slate', 'solar', 'superhero', 'vapor', 'cyborg'] else 'light' %}
{% macro px_to_rem(px_value, default_rem='0.375rem', base_font=16) %}
    {% if px_value is defined and px_value is number %}
        {{ (px_value | float / base_font) | round(3) }}rem
    {% else %}
        {{ default_rem }}
    {% endif %}
{% endmacro %}
{% macro hex_to_rgb_str(hex_color, default_rgb='0,0,0') %}
    {% set h = hex_color | replace('#', '') %}
    {% if h and h | length == 6 %}
        {{ h[0:2] | int(base=16) }},{{ h[2:4] | int(base=16) }},{{ h[4:6] | int(base=16) }}
    {% elif h and h | length == 3 %}
        {{ (h[0]*2) | int(base=16) }},{{ (h[1]*2) | int(base=16) }},{{ (h[2]*2) | int(base=16) }}
    {% else %}
        {{ default_rgb }} 
    {% endif %}
{% endmacro %}
{% set border_radius_rem = px_to_rem(settings.border_radius, default_rem='0.375rem') %}
{% set border_width_px = (settings.border_width | string) + 'px' if settings.border_width is defined and settings.border_width is number else '1px' %}
{% set font_size_rem = px_to_rem(settings.font_size, default_rem='1rem') %}
{% set primary_rgb_val = hex_to_rgb_str(settings.custom_colors.primary, default_rgb='13,110,253') %}
<!doctype html>
<html lang="pt-br" data-bs-theme="{{ theme_mode }}"> <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{% block title %}Nexlify FastAPI{% endblock %}</title>
    <link href="/static/css/bootstrap.min.css" rel="stylesheet">
    <link href="/static/css/custom.css" rel="stylesheet">
    {% include "_theme_style.html" %}
    <style>
        /* Estilos básicos para layout da sidebar (mantido) */
        body { display: flex; min-height: 100vh; background-color: var(--bs-secondary-bg); /* Fundo geral um pouco diferente */ }
        #sidebar { width: 280px; position: fixed; top: 0; left: 0; bottom: 0; z-index: 1030; border-right: var(--bs-border-width) solid var(--bs-border-color); transition: transform 0.3s ease-in-out; background-color: var(--bs-tertiary-bg); /* Fundo da sidebar */ }
        main { margin-left: 280px; padding: 1.5rem; flex-grow: 1; width: calc(100% - 280px); background-color: var(--bs-body-bg); /* Fundo do conteúdo principal */}
        @media (max-width: 991.98px) { #sidebar { transform: translateX(-100%); z-index: 1045; } #sidebar.show { transform: translateX(0); } main { margin-left: 0; width: 100%; } #sidebar-toggler { display: block !important; } }
        #sidebar-toggler { position: fixed; top: 10px; left: 10px; z-index: 1050; display: none; }
        .htmx-indicator { opacity: 0; transition: opacity 200ms ease-in; } .htmx-request .htmx-indicator { opacity: 1; } .htmx-request.htmx-indicator { opacity: 1; }
    </style>
<script src="https://unpkg.com/_hyperscript.org@0.9.12"></script>
</head>
<body>
    <button class="btn btn-light d-lg-none" type="button" data-bs-toggle="offcanvas" data-bs-target="#sidebarOffcanvas" aria-controls="sidebarOffcanvas" id="sidebar-toggler">
        ☰
    </button>
    <div class="offcanvas-lg offcanvas-start bg-body-tertiary" tabindex="-1" id="sidebarOffcanvas" aria-labelledby="sidebarOffcanvasLabel">
      <div class="offcanvas-header d-lg-none">
            <h5 class="offcanvas-title" id="sidebarOffcanvasLabel">Menu</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" data-bs-target="#sidebarOffcanvas" aria-label="Close"></button>
       </div>
       <div class="offcanvas-body p-0">
           <div id="sidebar"> {% include "_sidebar.html" %}
           </div>
       </div>
    </div>
    <main>
        {% block content %}{% endblock %}
    </main>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="/static/js/bootstrap.bundle.min.js"></script>
    <script src="/static/js/htmx.min.js"></script>
    <script src="/static/js/alpine.min.js" defer></script>
    <script nonce="{{ request.scope.get('csp_nonce', '') }}">
        const sidebar = document.getElementById('sidebar');
        const sidebarOffcanvas = document.getElementById('sidebarOffcanvas');
        // Adiciona/remove 'show' na sidebar real quando offcanvas é mostrado/escondido
        if (sidebarOffcanvas && sidebar) {
            sidebarOffcanvas.addEventListener('show.bs.offcanvas', () => {
                if (window.innerWidth < 992) { // Só aplica se estiver realmente no modo offcanvas
                     sidebar.classList.add('show');
                }
            });
            sidebarOffcanvas.addEventListener('hide.bs.offcanvas', () => {
                 if (window.innerWidth < 992) {
                     sidebar.classList.remove('show');
                 }
            });
             // Garante que a sidebar esteja visível em telas grandes no carregamento inicial
             // e que o offcanvas não fique 'aberto' por padrão em telas grandes
             function adjustSidebarVisibility() {
                 if (window.innerWidth >= 992) {
                     sidebar.classList.add('show');
                     // Força o fechamento do componente offcanvas se estiver aberto
                     const offcanvasInstance = bootstrap.Offcanvas.getInstance(sidebarOffcanvas);
                     if (offcanvasInstance) {
                         // offcanvasInstance.hide(); // Descomente se necessário, pode causar loop
                     }
                      sidebarOffcanvas.classList.remove('show'); // Garante que o backdrop não apareça
                 } else {
                     // Em telas pequenas, a visibilidade é controlada pelo 'show' no #sidebarOffcanvas
                      if (!sidebarOffcanvas.classList.contains('show')) {
                           sidebar.classList.remove('show');
                      }
                 }
             }
             // Ajusta no carregamento e no redimensionamento
             adjustSidebarVisibility();
             window.addEventListener('resize', adjustSidebarVisibility);
        }
    </script>
</body>
</html>