{% if error_message %}
<div class="alert alert-warning">{{ error_message }}</div>
{% else %}
<div class="card shadow-sm" x-data x-init="
    (async () => {
        try {
            await window.apexChartsLoaded;
            await new Promise(resolve => setTimeout(resolve, 500));
            const chartDiv = document.querySelector('#chart-pca-1');
            if (!chartDiv) {
                console.error('Elemento #chart-pca-1 não encontrado.');
                return;
            }
            if (typeof ApexCharts === 'undefined') {
                throw new Error('ApexCharts não carregado');
            }
            const chartData = {{ chart_pca | tojson | safe }};
            console.log('Dados PCA:', chartData);
            let isValid = chartData && typeof chartData === 'object' && chartData.series && Array.isArray(chartData.series);
            if (!isValid || chartData.error) {
                console.warn('Dados PCA inválidos:', chartData);
                chartDiv.innerHTML = '<div class=\'alert alert-warning small p-2 text-center\'>Gráfico PCA indisponível.</div>';
                return;
            }
            const chart = new ApexCharts(chartDiv, chartData);
            chart.render();
            chartDiv.style.minHeight = 'auto';
            console.log('✓ Gráfico PCA renderizado.');
        } catch (e) {
            console.error('Erro PCA:', e);
            document.querySelector('#chart-pca-1').innerHTML = '<div class=\'alert alert-danger small p-2 text-center\'>Erro no PCA. Verifique console.</div>';
        }
    })();
">
    <div class="card-body">
        <div id="chart-pca-1" style="min-height: 465px;">
            <div class="text-center p-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Carregando gráfico PCA...</span>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}